<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<h1 >Bhaukali face detector!!</h1>
	<video id="video" hidden="true" autoplay></video>

	<canvas id="canvas"></canvas>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

<script>
$(document).ready(function () {

	// Elements for taking the snapshot
	var w = null; var h = null;
	var canvas = document.getElementById('canvas');
	var context = canvas.getContext('2d');
	var video = document.getElementById('video');

	// Get access to the camera!
	if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
	    // Not adding `{ audio: true }` since we only want video now
	    const constraints = {
	    	advanced: [{
	    		facingMode: "environment"
	    	}]
	    };
	    navigator.mediaDevices
	    	.getUserMedia({ 
	    		video: true  // set it to `constraints` for rear view camera in mobile browser
	    	})
	    	.then(function(stream) {
	        video.srcObject = stream;
	        video.play();
	    });
	}

	setInterval(function(){
		
		if (video.videoWidth > 0){
			var t0 = performance.now();
			context.drawImage(video, 0, 0, w, h);
				// it takes some time to video to get videowidth.
			w = video.videoWidth;
			h = video.videoHeight;
			if (canvas.width != w){
				console.log('setting canvas dims');
				canvas.height = h;
				canvas.width = w;
				context = canvas.getContext('2d');
			}
			$.ajax({
				async: false,
		    type: 'POST',
		    url: "/postImage",
		    data: {'image': canvas.toDataURL("image/png")},
		    dataType: "text",
		    success: function(resultData) { 
		    	// console.log(resultData);
		    	var boxes = JSON.parse("[" + resultData + "]"); 
					var l = boxes[0].length;
					// console.log(l);
					var box;
			    for (var i = 0; i < l; i++) {
			    		box = boxes[0][i];
			    		// console.log("box", box);
			    		context.beginPath();
			    		context.strokeStyle="red";
							context.lineWidth="3";
							context.font = "20px Comic Sans MS";
							context.fillStyle = "red";
							context.fillText(box[0].toFixed(2), box[1], box[2]-5); 
			        context.rect(
			        	box[1], box[2],
			        	box[3] - box[1],
			        	box[4] - box[2],
			        );
			        context.stroke();
			    }
		    	// console.log("Image posted");
		    },
		    error: function(request, status, errror){
		    	console.log(request['status'])
		    }
		
			});
			var t1 = performance.now();
			console.log("Time taken: " + (t1 - t0) + " ms");
		}
	}, 10);

});	
</script>